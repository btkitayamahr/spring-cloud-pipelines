node {
	stage('Build and Upload') {
		deleteDir()
		sh 'git config --global http.sslVerify false'
		
		// git clone
		checkout([
			$class: 'GitSCM',
			branches: [
				[name: "*/${env.GIT_BRANCH_NAME ?: 'master'}"]
			],
			doGenerateSubmoduleConfigurations: false,
			extensions: [],
			submoduleCfg: [],
			userRemoteConfigs: [
				[
					credentialsId: env.GIT_CREDENTIAL_ID,
					url: env.GIT_REPOSITORY
				]
			]
		])

		// Build app and create docker image
		dir("${WORKSPACE}/contents") {
			withMaven( maven: "Maven") {
				sh 'mvn clean install'
			}
		}
	}

	stage('Deploy to test') {
		// Stop docker container
		sshPublisher(
			publishers: [
				sshPublisherDesc(
					configName: env.SSH_CONFIG_NAME_TEST,
					transfers: [
						sshTransfer(
							excludes: '',
							execCommand: 'sudo docker stop contents',
							execTimeout: 120000,
							flatten: false,
							makeEmptyDirs: false,
							noDefaultExcludes: false,
							patternSeparator: '[, ]+',
							remoteDirectory: '',
							remoteDirectorySDF: false,
							removePrefix: '',
							sourceFiles: ''
						)
					],
					usePromotionTimestamp: false,
					useWorkspaceInPromotion: false,
					verbose: false
				)
			]
		)
		sshPublisher(
			publishers: [
				sshPublisherDesc(
					configName: env.SSH_CONFIG_NAME_TEST,
					transfers: [
						sshTransfer(
							excludes: '',
							execCommand: 'sudo docker rm contents',
							execTimeout: 120000,
							flatten: false,
							makeEmptyDirs: false,
							noDefaultExcludes: false,
							patternSeparator: '[, ]+',
							remoteDirectory: '',
							remoteDirectorySDF: false,
							removePrefix: '',
							sourceFiles: ''
						)
					],
					usePromotionTimestamp: false,
					useWorkspaceInPromotion: false,
					verbose: false
				)
			]
		)
		sshPublisher(
			publishers: [
				sshPublisherDesc(
					configName: env.SSH_CONFIG_NAME_TEST,
					transfers: [
						sshTransfer(
							excludes: '',
							execCommand: 'sudo docker rmi ${env.DOCKER_REGISTRY_HOSTNAME}:${env.DOCKER_REGISTRY_PORT}/app/contents',
							execTimeout: 120000,
							flatten: false,
							makeEmptyDirs: false,
							noDefaultExcludes: false,
							patternSeparator: '[, ]+',
							remoteDirectory: '',
							remoteDirectorySDF: false,
							removePrefix: '',
							sourceFiles: ''
						)
					],
					usePromotionTimestamp: false,
					useWorkspaceInPromotion: false,
					verbose: false
				)
			]
		)
		sshPublisher(
			publishers: [
				sshPublisherDesc(
					configName: env.SSH_CONFIG_NAME_TEST,
					transfers: [
						sshTransfer(
							excludes: '',
							execCommand: 'sudo docker run -d --name contents -e EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://54.238.143.77:9000/eureka/ --net=msa_blank -p 9120:9120 ${env.DOCKER_REGISTRY_HOSTNAME}:${env.DOCKER_REGISTRY_PORT}/app/contents',
							execTimeout: 120000,
							flatten: false,
							makeEmptyDirs: false,
							noDefaultExcludes: false,
							patternSeparator: '[, ]+',
							remoteDirectory: '',
							remoteDirectorySDF: false,
							removePrefix: '',
							sourceFiles: ''
						)
					],
					usePromotionTimestamp: false,
					useWorkspaceInPromotion: false,
					verbose: false
				)
			]
		)
	}
}